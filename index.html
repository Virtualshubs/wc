class D3TwinsViewer extends HTMLElement {
  constructor() {
    super();
    // Shadow DOM cerrado para encapsular el iframe
    const shadow = this.attachShadow({ mode: "closed" });

    // Crear el iframe
    this.iframe = document.createElement("iframe");
    this.iframe.setAttribute("frameborder", "0");
    this.iframe.style = "width:100%;height:100%;border:0;";
    shadow.appendChild(this.iframe);
  }

  connectedCallback() {
    const viewerSrc = this.getAttribute("src"); // URL que apunta a viewer.3dtwins.tech
    if (!viewerSrc) {
      console.error("No se proporcionó src al 3d-twins-viewer");
      return;
    }

    // -------------------------------------------------
    // Función para decodificar token alien a Base64 y luego URL
    // -------------------------------------------------
    function decodeFinal(obfuscated) {
      const mapIn  = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
      const mapOut = "ᚠᛃᛗᛚᛞᚹᛝᛣᛥᛡᚵᚿᛇᛵᛨᛶᚤ᛭ᛪᛳᚾᚨᛎᛊᛱ" +
                     "ʭʮʯʰʱʲʳʴʵʶʷʸʹʺ" +
                     "֍֎֏" +
                     "౹౺౻౼౽౾" +
                     "ჵჶჷჸჹ" +
                     "ᗧᗨᗩᗪᗫᗬᗭᗮᗯ";
      let base64 = "";
      for (let char of obfuscated) {
        const idx = mapOut.indexOf(char);
        base64 += idx === -1 ? char : mapIn[idx];
      }
      try {
        return atob(base64);
      } catch (e) {
        console.error("❌ decodeFinal error:", e, base64);
        return "";
      }
    }

    // -------------------------------------------------
    // Detectar si hay token alien en la query
    // -------------------------------------------------
    const urlObj = new URL(viewerSrc);
    const alienToken = urlObj.searchParams.get('ᚨᚷ');

    let finalURL = viewerSrc;
    if (alienToken) {
      const decoded = decodeFinal(alienToken);
      // Reconstruir URL apuntando a LOAD con el query completo decodificado
      finalURL = `https://load.3dtwins.tech/?${decoded.split('?')[1] || ''}`;
    } else {
      // Si no hay token alien, simplemente pasar viewer → load
      finalURL = viewerSrc.replace(/^https?:\/\/viewer\.3dtwins\.tech/, "https://load.3dtwins.tech");
    }

    // Asignar al iframe
    this.iframe.src = finalURL;
  }
}

// Registrar el WebComponent
customElements.define("d3-twins-viewer", D3TwinsViewer);
