class D3TwinsViewer extends HTMLElement {
  constructor() {
    super();
    // Shadow DOM cerrado para encapsular el iframe
    const shadow = this.attachShadow({ mode: "closed" });

    // Crear el iframe
    this.iframe = document.createElement("iframe");
    this.iframe.setAttribute("frameborder", "0");
    this.iframe.style = "width:100%;height:100%;border:0;";
    shadow.appendChild(this.iframe);
  }

  connectedCallback() {
    const viewerSrc = this.getAttribute("src"); // URL que apunta a viewer.3dtwins.tech
    if (!viewerSrc) {
      console.error("No se proporcionó src al d3-twins-viewer");
      return;
    }

    // Transformar viewer -> load, manteniendo parámetros intactos
    const loadURL = viewerSrc.replace(
      /^https?:\/\/viewer\.3dtwins\.tech/,
      "https://load.3dtwins.tech/index2.html"
    );

    // ⚠️ Detectar si la URL contiene caracteres fuera del ASCII estándar
    const hasUnicode = /[^\x20-\x7E]/.test(loadURL);

    if (hasUnicode) {
      // Usar srcdoc para preservar Unicode exactamente como está
      this.iframe.srcdoc = `<script>window.location.href="${loadURL}";</script>`;
    } else {
      // Si solo hay ASCII, asignar directamente
      this.iframe.src = loadURL;
    }
  }
}

// Registrar el WebComponent
customElements.define("d3-twins-viewer", D3TwinsViewer);
