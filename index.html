class D3TwinsViewer extends HTMLElement {
  constructor() {
    super();
    // Shadow DOM cerrado para encapsular el iframe
    const shadow = this.attachShadow({ mode: "closed" });

    // Crear el iframe
    this.iframe = document.createElement("iframe");
    this.iframe.setAttribute("frameborder", "0");
    this.iframe.style = "width:100%;height:100%;border:0;";
    shadow.appendChild(this.iframe);
  }

  connectedCallback() {
    let viewerSrc = this.getAttribute("src"); // URL que apunta a viewer.3dtwins.tech
    if (!viewerSrc) {
      console.error("No se proporcionó src al d3-twins-viewer");
      return;
    }

    // ⚠️ Decodificar parámetros alienígenas si vienen codificados
    try {
      const urlParts = viewerSrc.split("?");
      if (urlParts[1]) {
        urlParts[1] = decodeURIComponent(urlParts[1]);
        viewerSrc = `${urlParts[0]}?${urlParts[1]}`;
      }
    } catch(e) {
      console.warn("No se pudo decodificar la URL:", e);
    }

    // ⚠️ Transformar solo el dominio viewer -> load, dejando intactos los parámetros
    const loadURL = viewerSrc.replace(
      /^https?:\/\/viewer\.3dtwins\.tech/,
      "https://load.3dtwins.tech"
    );

    // ⚠️ Asignar al iframe directamente, sin encodeURIComponent ni cambios en parámetros
    this.iframe.src = loadURL;

    // ⚠️ Opcional: inyectar script del WebComponent si necesitas funcionalidad adicional
    if (!document.querySelector('script[data-d3-twins]')) {
      const scriptEl = document.createElement('script');
      scriptEl.type = 'module';
      scriptEl.src = 'https://viewer.3dtwins.tech/';
      scriptEl.setAttribute('data-d3-twins', 'true');
      document.head.appendChild(scriptEl);
    }
  }
}

// Registrar el WebComponent
customElements.define("d3-twins-viewer", D3TwinsViewer);

