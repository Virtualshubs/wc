class D3TwinsViewer extends HTMLElement {
  constructor() {
    super();
    
    const shadow = this.attachShadow({ mode: "closed" });

    this.iframe = document.createElement("iframe");
    this.iframe.setAttribute("frameborder", "0");
    this.iframe.style = "width:100%;height:100%;border:0;";
    shadow.appendChild(this.iframe);
  }

  connectedCallback() {
    let viewerSrc = this.getAttribute("src"); 
    if (!viewerSrc) {
      console.error("No se proporcionÃ³ src al d3-twins-viewer");
      return;
    }

    // ðŸŸ£ NORMALIZAR URL (evita problemas con encode doble)
    try {
      const urlObj = new URL(viewerSrc);
      if (urlObj.searchParams.has("áš¨áš·")) {
        const token = urlObj.searchParams.get("áš¨áš·");
        urlObj.searchParams.set("áš¨áš·", encodeURIComponent(token)); // reforzamos
        viewerSrc = urlObj.toString();
      }
    } catch(err) {
      console.warn("No se pudo normalizar el parÃ¡metro áš¨áš·:", err);
    }

    // ðŸ”¥ Mantener todo igual: solo se cambia viewer â†’ load
    const loadURL = viewerSrc.replace(
      /^https?:\/\/viewer\.3dtwins\.tech/,
      "https://load.3dtwins.tech"
    );

    this.iframe.src = loadURL;
  }
}

customElements.define("d3-twins-viewer", D3TwinsViewer);
